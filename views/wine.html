<!-- Title -->
{{ define "title" }}
    <title>Wine Database|Wine</title>
{{ end }}
<!-- Description -->
{{ define "description" }}
    <meta name="description" content="This is the wine app wine page">
{{ end }}
<!-- Body -->
{{ define "body" }}
    <style>
        /* Small devices (tablets, 768px and up) */
        @media (min-width: 768px) {
            #map {
                height: 265px;
            }
        }

        /* Medium devices (desktops, 992px and up) */
        @media (min-width: 992px) {
            #map {
                height: 450px;
            }
        }

        /* Large devices (large desktops, 1200px and up) */
        @media (min-width: 1200px) {
            #map {
                height: 585px;
            }
        }
    </style>
    <div class="row">
        <div class="col-sm-12">
            <h1>
                {{.Wine.Winery}} {{with .Wine.Name }}{{ . }} {{end}}{{ .Wine.Variety.Name }}<br/>
                <small>{{ .Wine.Style }} wine{{with .Wine.Region}} from {{ . }}{{end}}</small>
            </h1>
            <!-- TODO display partial stars without rounding -->
            <span class="rating" rating="{{printf "%.1f" .Stats.AvgRating }}"></span>
            <strong>&nbsp;&nbsp;&nbsp;Best: {{ .Stats.BestYears }}</strong>
        </div>
        {{with .Wine.Information}}
            <div class="row text-center col-sm-10 col-sm-offset-1">
                    <em style="font-size:1.6rem">{{ . }}</em><br/><br/>
            </div>
        {{end}}
        {{with .Stats.LastImage}}
            <div class="col-sm-6 col-sm-push-6">
                <img src="//data.wineapp.org/{{.}}" alt="Bottle Image" class="img-responsive">
            </div>
        {{end}}
        <div class="col-sm-6 {{with .Stats.LastImage}}col-sm-pull-6{{end}}">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <strong  style="font-size:1.6rem;">Price Information</strong>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-sm-4">
                            <strong>Lowest Regular</strong>
                        </div>
                        <div class="col-sm-8">
                            <a href="/purchase/{{ .Stats.MinRegularPurchase.Id.Hex }}">${{printf "%.2f" .Stats.MinRegularPrice }} at {{ .Stats.MinRegularPurchase.Store.Name }}</a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4">
                            <strong>Lowest On Sale</strong>
                        </div>
                        <div class="col-sm-8">
                            <a href="/purchase/{{ .Stats.MinSalePurchase.Id.Hex }}">${{printf "%.2f" .Stats.MinSalePrice }} at {{ .Stats.MinSalePurchase.Store.Name }}</a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4">
                            <strong>Highest</strong>
                        </div>
                        <div class="col-sm-8">
                            <a href="/purchase/{{ .Stats.MaxPurchase.Id.Hex }}">${{printf "%.2f" .Stats.MaxPrice }} at {{ .Stats.MaxPurchase.Store.Name }}</a>
                        </div>
                    </div>
                    <!-- FUTUREUPGRADE Price Histogram (average on graph)<br> -->
                </div>
            </div>
            <div id="map" class="visible-sm-block visible-md-block visible-lg-block"></div>
            <script src="//maps.googleapis.com/maps/api/js?v=3.exp"></script>
            <script>
                var map = new google.maps.Map(document.getElementById('map')),
                    markers = [],
                    bounds = new google.maps.LatLngBounds(),
                    infowindow = new google.maps.InfoWindow({
                        maxWidth: 200
                    });

                var stores =[
                    {{range $store := .Stores}}
                        {
                            name: {{$store.Store.Name}},
                            address: {{$store.Store.Address}} + "<br>" + {{$store.Store.City}} + ", " + {{$store.Store.State}} + " " + {{$store.Store.Zip}},
                            lat: {{$store.Store.Lattitude}},
                            lng: {{$store.Store.Longitutde}},
                            website: {{$store.Store.Website}},
                            lastPurchase: {{$store.Store.LastPurchased.Format "Jan 2, 2006" }},
                            numPurchased: {{$store.Store.NumPurchased}},
                            minPrice: "$" + {{printf "%.2f" $store.Store.MinPrice}},
                        },
                    {{end}}
                ];

                google.maps.event.addDomListener(window, "load", initialize);
                function initialize() {
                    stores.forEach(function(result, i) {
                        var marker = new google.maps.Marker({
                            position: new google.maps.LatLng(result.lat, result.lng),
                            title: result.name,
                            map: map
                        });
                        result.marker = marker;
                        markers.push(marker);
                        bounds.extend(marker.position);
                        result.infoWindowContent = "<h4><a href='//" + result.website + "'>" + result.name + "</a></h4><strong>Address</strong><br>" + result.address+ "<br><br>" + "<strong>Last Purchased</strong><br>" + result.lastPurchase + "<br><br>" + "<strong>Number of Purchases</strong><br>" + result.numPurchased + "<br><br>" + "<strong>Lowest Price</strong><br>" + result.minPrice;

                        google.maps.event.addListener(marker, 'click', (function(marker, i) {
                            return function() {
                                infowindow.setContent(result.infoWindowContent);
                                infowindow.open(map, marker);
                            };
                        })(marker, i));
                    });

                    map.fitBounds(bounds);
                }
            </script>
        </div>
    </div>
    <h2 class="col-sm-12 row">Purchases by Store</h2>
    {{range $store := .Stores }}
        <div class="col-sm-12 row">
            <div class="panel panel-default">
                <div class="panel-heading"><strong style="font-size:1.6rem;"><a href="/store/{{ $store.Store.Id.Hex }}">{{ $store.Store.Name }} - {{ $store.Store.City }}</a></strong></div>
                <div class="panel-body">
                    {{range $index, $purchase := $store.Purchases}}
                        <div class="purchase col-sm-4">
                        {{if ne $index 0}}<hr class="hidden-sm hidden-md hidden-lg">{{end}}
                            <div>
                                <strong><a href="/purchase/{{$purchase.Id.Hex}}">{{ $purchase.DatePurchased.Format "January 2, 2006" }}</a></strong>
                            </div>
                            <em>{{ $purchase.Year }} Vintage</em><br>
                            <span class="rating" rating="{{ $purchase.Rating }}"></span>{{with $purchase.BuyAgain }}<strong>&nbsp;&nbsp;&nbsp;Buy again!</strong>{{end}}<br>
                            <div class="row">
                                <div class="col-sm-5">
                                    <strong>Price</strong>
                                </div>
                                <div class="col-sm-7">
                                    ${{printf "%.2f" $purchase.Price}}{{with $purchase.OnSale }} (On sale){{end}}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-5">
                                    <strong>Date Drank</strong>
                                </div>
                                <div class="col-sm-7">
                                    {{if not $purchase.DateDrank.IsZero }}{{ $purchase.DateDrank.Format "Jan 2, 2006"}}{{else}}Not Entered{{end}}
                                </div>
                            </div>
                        </div>
                    {{end }}
                </div>
            </div>
        </div>
    {{ end }}
    <script src="/js/jquery.raty.js"></script>
    <script>
    $(".rating").raty({
        path: "/img/",
        hints: ["Bad", "Poor", "Regular", "Good", "Great"],
        readOnly: true,
        score: function() {
            return $(this).attr("rating");
          },
    });
    </script>
{{ end }}
